{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studyagent.dev/schemas/tutor_rl/prefs.schema.json",
  "title": "TutorRLPreferenceRecord",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "observation",
    "candidates",
    "preference"
  ],
  "properties": {
    "observation": {
      "type": "object",
      "description": "Observation snapshot identical to SFT records."
    },
    "candidates": {
      "type": "array",
      "minItems": 2,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["action", "response"],
        "properties": {
          "action": {
            "type": "object",
            "required": ["type"],
            "properties": {
              "type": {"type": "string"}
            },
            "additionalProperties": true
          },
          "response": {
            "type": "string",
            "minLength": 1
          },
          "reward": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "components",
              "total",
              "weights",
              "normalized_weights",
              "flags"
            ],
            "properties": {
              "components": {
                "type": "object",
                "minProperties": 1,
                "additionalProperties": {
                  "type": "object",
                  "required": ["score", "details", "flags"],
                  "additionalProperties": false,
                  "properties": {
                    "score": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    },
                    "details": {
                      "type": "object"
                    },
                    "flags": {
                      "type": "array",
                      "items": {"type": "string"}
                    }
                  }
                }
              },
              "total": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "weights": {
                "type": "object",
                "additionalProperties": {
                  "type": "number",
                  "minimum": 0
                }
              },
              "normalized_weights": {
                "type": "object",
                "additionalProperties": {
                  "type": "number",
                  "minimum": 0
                }
              },
              "flags": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          },
          "critic": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "clarity",
              "accuracy",
              "support",
              "hallucination_flag",
              "confidence"
            ],
            "properties": {
              "clarity": {"type": "number", "minimum": 0, "maximum": 1},
              "accuracy": {"type": "number", "minimum": 0, "maximum": 1},
              "support": {"type": "number", "minimum": 0, "maximum": 1},
              "hallucination_flag": {"type": "boolean"},
              "notes": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1},
              "prompt_set": {"type": "string"}
            }
          },
          "meta": {
            "type": "object"
          }
        }
      }
    },
    "preference": {
      "type": "object",
      "additionalProperties": false,
      "required": ["chosen", "scores", "confidence"],
      "properties": {
        "chosen": {
          "type": "integer",
          "minimum": 0
        },
        "scores": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "reason": {
          "type": "string"
        },
        "prompt_set": {
          "type": "string"
        }
      }
    },
    "meta": {
      "type": "object",
      "default": {}
    }
  }
}

